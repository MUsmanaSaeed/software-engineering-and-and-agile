{% if selected_order_no and order_details %}
{% set not_received_orders = order_details|selectattr('received_date', '==', None)|selectattr('canceled_date', '==', None)|sort(attribute='expected_date')|list %}
{% set due_today_orders = not_received_orders|selectattr('expected_date', 'equalto', current_date)|list %}
{% set other_not_received_orders = not_received_orders|rejectattr('expected_date', 'equalto', current_date)|list %}
{% set received_orders = order_details|selectattr('received_date', '!=', None)|selectattr('canceled_date', '==', None)|sort(attribute='expected_date')|list %}
{% set canceled_orders = order_details|selectattr('canceled_date', '!=', None)|sort(attribute='expected_date')|list %}
<div id="order-detail-panel" class="card flex-grow-1 h-100">
    <div class="order-detail-header d-flex align-items-center justify-content-between">
        <div>
            <i class="bi bi-truck"></i>
            <span class="order-detail-title">Order No: {{ selected_order_no }}</span>
        </div>
        <a href="#" class="btn order-detail-add-btn ms-2" data-bs-toggle="modal" data-bs-target="#addOrderModal">Add Order</a>
    </div>
    <div class="card-body d-flex flex-column h-100">
        <div class="order-list flex-grow-1 overflow-auto" style="max-height: 80vh;">
            {# Show due today orders at the very top #}
            {% for order in due_today_orders %}
            <div class="order-list-item mb-3 p-0 rounded shadow-sm order-vertical-layout">
                <button class="order-collapse-btn w-100 text-start p-3 border-0 bg-transparent d-flex align-items-center" type="button" data-bs-toggle="collapse" data-bs-target="#order-{{ order.id }}-collapse" aria-expanded="false" aria-controls="order-{{ order.id }}-collapse" title="Click for more details">
                    <i class="bi bi-chevron-down me-2"></i>
                    <span><strong>Brick:</strong> {{ order.brick.name }} ({{ order.brick.manufacturer.name }}) &mdash; <strong>Expected:</strong> {{ order.expected_date.strftime('%d/%m/%y') }} &mdash; <strong>Ordered:</strong> {{ order.bricks_ordered }}</span>
                </button>
                <div class="collapse" id="order-{{ order.id }}-collapse">
                    <div class="order-list-info-actions d-flex justify-content-between align-items-start px-3 pb-3 pt-1">
                        <div class="order-list-info">
                            <div><strong>Bricks Ordered:</strong><br> {{ order.bricks_ordered }}</div>
                            <div><strong>Bricks Received:</strong><br> {{ order.bricks_received }}</div>
                            <div><strong>Ordered Date:</strong><br> {{ order.ordered_date.strftime('%d/%m/%y') }}</div>
                            <div><strong>Expected Date:</strong><br> {{ order.expected_date.strftime('%d/%m/%y') }}</div>
                        </div>
                        <div class="order-list-actions d-flex flex-column align-items-end ms-3">
                            <form method="POST" action="{{ url_for('orders.mark_received', order_id=order.id) }}" style="display:inline;" class="mark-received-form">
                                <button type="button" class="btn btn-order-received btn-sm mb-2" data-order-id="{{ order.id }}" data-bricks-ordered="{{ order.bricks_ordered }}">Order Received</button>
                            </form>
                            <form method="POST" action="{{ url_for('orders.cancel_order', order_id=order.id) }}" style="display:inline;" class="cancel-order-form">
                                <button type="button" class="btn btn-order-cancel btn-sm" data-order-id="{{ order.id }}">Cancel</button>
                            </form>
                            <button type="button" class="btn btn-order-edit btn-sm" data-order-id="{{ order.id }}" data-order-no="{{ order.orderNo }}" data-brick="{{ order.brick.name }} ({{ order.brick.manufacturer.name }})" data-bricks-ordered="{{ order.bricks_ordered }}" data-ordered-date="{{ order.ordered_date.strftime('%Y-%m-%d') }}" data-expected-date="{{ order.expected_date.strftime('%Y-%m-%d') }}">Edit</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
            {# Show other not received orders (overdue and future) #}
            {% for order in other_not_received_orders %}
            {% set is_overdue = order.expected_date < current_date %}
            <div class="order-list-item mb-3 p-0 rounded shadow-sm order-vertical-layout{% if is_overdue %} order-overdue-bg{% endif %}">
                <button class="order-collapse-btn w-100 text-start p-3 border-0 bg-transparent d-flex align-items-center" type="button" data-bs-toggle="collapse" data-bs-target="#order-{{ order.id }}-collapse" aria-expanded="false" aria-controls="order-{{ order.id }}-collapse" title="Click for more details">
                    <i class="bi bi-chevron-down me-2"></i>
                    <span><strong>Brick:</strong> {{ order.brick.name }} ({{ order.brick.manufacturer.name }}) &mdash; <strong>Expected:</strong> {{ order.expected_date.strftime('%d/%m/%y') }} &mdash; <strong>Ordered:</strong> {{ order.bricks_ordered }}</span>
                </button>
                <div class="collapse" id="order-{{ order.id }}-collapse">
                    <div class="order-list-info-actions d-flex justify-content-between align-items-start px-3 pb-3 pt-1">
                        <div class="order-list-info">
                            <div><strong>Bricks Ordered:</strong><br> {{ order.bricks_ordered }}</div>
                            <div><strong>Bricks Received:</strong><br> {{ order.bricks_received }}</div>
                            <div><strong>Ordered Date:</strong><br> {{ order.ordered_date.strftime('%d/%m/%y') }}</div>
                            <div><strong>Expected Date:</strong><br> {{ order.expected_date.strftime('%d/%m/%y') }}</div>
                        </div>
                        <div class="order-list-actions d-flex flex-column align-items-end ms-3">
                            <form method="POST" action="{{ url_for('orders.mark_received', order_id=order.id) }}" style="display:inline;" class="mark-received-form">
                                <button type="button" class="btn btn-order-received btn-sm mb-2" data-order-id="{{ order.id }}" data-bricks-ordered="{{ order.bricks_ordered }}">Order Received</button>
                            </form>
                            <form method="POST" action="{{ url_for('orders.cancel_order', order_id=order.id) }}" style="display:inline;" class="cancel-order-form">
                                <button type="button" class="btn btn-order-cancel btn-sm" data-order-id="{{ order.id }}">Cancel</button>
                            </form>
                            <button type="button" class="btn btn-order-edit btn-sm" data-order-id="{{ order.id }}" data-order-no="{{ order.orderNo }}" data-brick="{{ order.brick.name }} ({{ order.brick.manufacturer.name }})" data-bricks-ordered="{{ order.bricks_ordered }}" data-ordered-date="{{ order.ordered_date.strftime('%Y-%m-%d') }}" data-expected-date="{{ order.expected_date.strftime('%Y-%m-%d') }}">Edit</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
            {# Show received orders at the bottom, sorted by expected date #}
            {% for order in received_orders %}
            <div class="order-list-item mb-3 p-0 rounded shadow-sm order-vertical-layout order-received-bg">
                <div class="d-flex align-items-center justify-content-between w-100">
                    <button class="order-collapse-btn text-start p-3 border-0 bg-transparent d-flex align-items-center flex-grow-1" type="button" data-bs-toggle="collapse" data-bs-target="#order-{{ order.id }}-collapse" aria-expanded="false" aria-controls="order-{{ order.id }}-collapse" title="Click for more details">
                        <i class="bi bi-chevron-down me-2"></i>
                        <span><strong>Brick:</strong> {{ order.brick.name }} ({{ order.brick.manufacturer.name }}) &mdash; <strong>Received:</strong> {{ order.received_date.strftime('%d/%m/%y') }}</span>
                    </button>
                    <span class="badge badge-received me-3">Received</span>
                </div>
                <div class="collapse" id="order-{{ order.id }}-collapse">
                    <div class="order-list-info px-3 pb-3 pt-1">
                        <div><strong>Bricks Ordered:</strong><br> {{ order.bricks_ordered }}</div>
                        <div><strong>Bricks Received:</strong><br> {{ order.bricks_received }}</div>
                        <div><strong>Ordered Date:</strong><br> {{ order.ordered_date.strftime('%d/%m/%y') }}</div>
                        <div><strong>Expected Date:</strong><br> {{ order.expected_date.strftime('%d/%m/%y') }}</div>
                        <div><strong>Received Date:</strong><br> {{ order.received_date.strftime('%d/%m/%y') }}</div>
                    </div>
                </div>
            </div>
            {% endfor %}
            {# Show canceled orders at the very bottom, sorted by expected date #}
            {% for order in canceled_orders %}
            {% set is_overdue_canceled = order.expected_date < current_date %}
            <div class="order-list-item mb-3 p-0 rounded shadow-sm order-vertical-layout{% if is_overdue_canceled %} order-canceled-bg{% endif %}">
                <div class="d-flex align-items-center justify-content-between w-100">
                    <button class="order-collapse-btn text-start p-3 border-0 bg-transparent d-flex align-items-center flex-grow-1" type="button" data-bs-toggle="collapse" data-bs-target="#order-{{ order.id }}-collapse" aria-expanded="false" aria-controls="order-{{ order.id }}-collapse" title="Click for more details">
                        <i class="bi bi-chevron-down me-2"></i>
                        <span><strong>Brick:</strong> {{ order.brick.name }} ({{ order.brick.manufacturer.name }}) &mdash; <strong>Canceled:</strong> {{ order.canceled_date.strftime('%d/%m/%y') }}</span>
                    </button>
                    <span class="badge badge-canceled me-3">Canceled</span>
                </div>
                <div class="collapse" id="order-{{ order.id }}-collapse">
                    <div class="order-list-info px-3 pb-3 pt-1">
                        <div><strong>Bricks Ordered:</strong><br> {{ order.bricks_ordered }}</div>
                        <div><strong>Bricks Received:</strong><br> {{ order.bricks_received }}</div>
                        <div><strong>Ordered Date:</strong><br> {{ order.ordered_date.strftime('%d/%m/%y') }}</div>
                        <div><strong>Expected Date:</strong><br> {{ order.expected_date.strftime('%d/%m/%y') }}</div>
                        <div><strong>Canceled Date:</strong><br> {{ order.canceled_date.strftime('%d/%m/%y') }}</div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% else %}
<!-- Placeholder shown when no order is selected -->
<div id="order-placeholder-panel" class="card flex-grow-1 h-100">
    <div class="card-body d-flex flex-column h-100 align-items-center justify-content-center text-muted">
        <div class="text-center">
            <i class="bi bi-truck" style="font-size: 3rem;"></i>
            <h5 class="mt-3">No order selected</h5>
            <p>Select an order from the list to view its details.</p>
        </div>
    </div>
</div>
{% endif %}

<link rel="stylesheet" href="{{ url_for('static', filename='css/orders.css') }}">
