{% extends 'base.html' %}
{% block title %}{% if user %}Edit{% else %}Add{% endif %} User{% endblock %}
{% block content %}
<div class="d-flex justify-content-center align-items-center" style="min-height: 80vh;">
    <div class="col-12 col-sm-8 col-md-5 col-lg-4">
        <div class="card shadow">
            <div class="card-header text-center"><h4>{% if user %}Edit{% else %}Add{% endif %} User</h4></div>
            <div class="card-body">
                <form method="POST" id="userForm">
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <div class="input-group has-validation">
                            <span class="input-group-text bg-white border-end-0 p-0" id="usernameErrorIcon" style="display: none;"><i class="bi bi-exclamation-circle text-danger"></i></span>
                            <input type="text" name="userName" class="form-control{% if error_fields and 'userName' in error_fields %} is-invalid{% endif %}" value="{{ user.userName if user else '' }}" required aria-describedby="usernameErrorIcon">
                        </div>
                    </div>
                    <div class="mb-3 position-relative">
                        <label class="form-label">Password {% if user %}<span class="text-muted">(leave blank to keep current)</span>{% endif %}</label>
                        <div class="input-group has-validation position-relative" style="width: 100%;">
                            <span class="input-group-text bg-white border-end-0 p-0" id="passwordErrorIcon" style="display: none;"><i class="bi bi-exclamation-circle text-danger"></i></span>
                            <input type="password" name="password" class="form-control pe-5{% if error_fields and 'password' in error_fields %} is-invalid{% endif %}" id="passwordInput" {% if not user %}required{% endif %} style="padding-right: 2.5rem; position: relative; z-index: 1; background-color: transparent;" aria-describedby="passwordErrorIcon">
                            <button type="button" class="peek-btn-login" id="togglePassword" tabindex="0">
                                <i class="bi bi-eye" id="togglePasswordIcon"></i>
                            </button>
                        </div>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="isAdmin" id="isAdmin" {% if user and user.isAdmin %}checked{% endif %}{% if user and user.id == session['userId'] %} disabled{% endif %}>
                        <label class="form-check-label" for="isAdmin">Admin</label>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">{% if user %}Update{% else %}Add{% endif %} User</button>
                </form>
                <div id="formMessage" class="mt-2"></div>
            </div>
            <div class="card-footer text-center">
                <a href="{{ url_for('manage_users.users') }}" class="btn btn-link">Back to Users</a>
            </div>
        </div>
    </div>
</div>
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<style>
/* Animation for form message */
#formMessage {
    opacity: 0;
    transform: translateY(-10px) scale(0.98);
    pointer-events: none;
    transition: opacity 0.4s cubic-bezier(.4,2,.6,1), transform 0.4s cubic-bezier(.4,2,.6,1);
}
#formMessage.show {
    opacity: 1;
    transform: translateY(0) scale(1);
    pointer-events: auto;
}
.is-invalid {
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 0.2rem rgba(220,53,69,.25);
}
/* Fix show password button alignment */
#passwordInput {
    padding-right: 2.5rem !important;
}
</style>
<script src="{{ url_for('static', filename='peek.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('userForm');
    const messageDiv = document.getElementById('formMessage');
    // Remove is-invalid on input
    [form.userName, form.password].forEach(function(input) {
        if (input) {
            input.addEventListener('input', function() {
                if (input.classList.contains('is-invalid')) {
                    if ((input.name === 'userName' && input.value.length >= 3) ||
                        (input.name === 'password' && (input.value.length === 0 || input.value.length >= 8))) {
                        input.classList.remove('is-invalid');
                    }
                }
            });
        }
    });
    function showMessage(html) {
        messageDiv.innerHTML = html;
        // Force reflow to restart animation if needed
        void messageDiv.offsetWidth;
        messageDiv.classList.add('show');
        // Remove any previous listeners
        removeInputListeners();
        // Add listeners to hide message only when all fields are valid/changed
        addInputListeners();
    }
    function hideMessage() {
        messageDiv.classList.remove('show');
        // Don't clear innerHTML until the transition is done
        const onTransitionEnd = (e) => {
            if (e.propertyName === 'opacity') {
                messageDiv.innerHTML = '';
                messageDiv.removeEventListener('transitionend', onTransitionEnd);
            }
        };
        messageDiv.addEventListener('transitionend', onTransitionEnd);
    }
    // Helper to check if all conditions are met
    function conditionsMet() {
        // Username must be at least 3 characters
        const userNameValid = form.userName.value.length >= 3;
        // Password must be at least 8 characters, or blank if not required
        const passwordValid = !form.password.required || form.password.value.length >= 8 || form.password.value.length === 0;
        let isAdminValid = true;
        if (form.isAdmin && !form.isAdmin.disabled) {
            isAdminValid = true; // No specific validation, but can be extended
        }
        return userNameValid && passwordValid && isAdminValid;
    }
    // Remove previous listeners
    function removeInputListeners() {
        if (form._clearMessageListeners) {
            form._clearMessageListeners.forEach(({el, fn, evt}) => el.removeEventListener(evt, fn));
        }
        form._clearMessageListeners = [];
    }
    // Add listeners to hide message only when all conditions are met
    function addInputListeners() {
        form._clearMessageListeners = [];
        const tryHide = () => {
            setTimeout(() => {
                // Only hide if the current message is related to the requirement and the requirement is now met
                const messageText = messageDiv.textContent.trim();
                if (
                    (messageText.includes('Username must be at least') && form.userName.value.length >= 3) ||
                    (messageText.includes('Password must be at least') && (form.password.value.length >= 8 || form.password.value.length === 0))
                ) {
                    hideMessage();
                    removeInputListeners();
                }
            }, 0);
        };
        form.userName.addEventListener('input', tryHide);
        form._clearMessageListeners.push({el: form.userName, fn: tryHide, evt: 'input'});
        if (form.password) {
            form.password.addEventListener('input', tryHide);
            form._clearMessageListeners.push({el: form.password, fn: tryHide, evt: 'input'});
        }
        if (form.isAdmin && !form.isAdmin.disabled) {
            form.isAdmin.addEventListener('change', tryHide);
            form._clearMessageListeners.push({el: form.isAdmin, fn: tryHide, evt: 'change'});
        }
    }
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(form);
        fetch(window.location.pathname, {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            body: formData
        })
        .then(response => response.json().then(data => ({ status: response.status, body: data })))
        .then(({ status, body }) => {
            // Do not hide the message immediately
            if (body.success) {
                if (body.redirect) {
                    window.location.href = body.redirect;
                    return;
                }
                showMessage(`<div class='alert alert-success'>${body.message}</div>`);
                if (body.user) {
                    form.userName.value = body.user.userName;
                    if (form.isAdmin) form.isAdmin.checked = body.user.isAdmin;
                }
                form.password.value = '';
            } else {
                showMessage(`<div class='alert alert-danger'>${body.message || 'An error occurred.'}</div>`);
                // Highlight invalid fields
                if (body.error_fields) {
                    if (body.error_fields.includes('userName')) form.userName.classList.add('is-invalid');
                    if (body.error_fields.includes('password')) form.password.classList.add('is-invalid');
                }
            }
        })
        .catch(() => {
            showMessage(`<div class='alert alert-danger'>An error occurred. Please try again.</div>`);
        });
    });
});
</script>
{% endblock %}
